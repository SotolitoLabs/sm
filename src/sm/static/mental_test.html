<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Salud Mental - Responder test</title>
  <!-- MDB icon -->
  <link rel="icon" href="img/mdb-favicon.ico" type="image/x-icon">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css">
  <!-- Google Fonts Roboto -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <!-- Material Design Bootstrap -->
  <link rel="stylesheet" href="css/mdb.min.css">
  <!-- Your custom styles (optional) -->
  <link rel="stylesheet" href="css/style.css">
  <script src="/static/rest_framework/js/jquery-3.4.1.min.js"></script>
  <script src="/static/rest_framework/js/ajax-form.js"></script>
  <script src="/static/rest_framework/js/csrf.js"></script>
  <script src="/static/rest_framework/js/bootstrap.min.js"></script>
  <script src="/static/rest_framework/js/prettify-min.js"></script>
  <script src="/static/rest_framework/js/default.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>


<!-- SLIDER -->
<link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>

<style>

body {
    font-family: 'Roboto';font-size: 16px; color: grey;
    background-color: #FDF6E6
}

.slidecontainer {
  width: 100%;
  margin-top: 60px;
}

.slider {
  -webkit-appearance: none;
  width: 50%;
  height: 25px;
  background: #d3d3d3;
  outline: none;
  opacity: 0.7;
  -webkit-transition: .2s;
  transition: opacity .2s;
  border-radius: 15px;
}

.slider:hover {
  opacity: 1;
}

.slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 60px;
  height: 60px;
  background: orange;
  background-image: url("https://img.icons8.com/cotton/2x/button--v2.png");
  background-repeat:no-repeat;
  background-size:cover;
  cursor: pointer;
  border-radius: 30px;
}

.slider::-moz-range-thumb {
  width: 25px;
  height: 25px;
  background: #4CAF50;
  cursor: pointer;
}

.button {
  background-color: #E15555;
  border: none;
  color: white;
  padding: 15px 32px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  margin: 60px 2px;
  cursor: pointer;
}

.collapsed-question {
  display: none;
}

</style>
<script>
/* var slider = document.getElementById("question_range");
var output = document.getElementById("output"); */
var slider = "";
var output = "";
</script>

<!-- SLIDER -->

</head>
<body>

<!-- Start your project here--> 
<!--Main Navigation-->
<header>

  <!--Navbar-->
  <nav class="navbar navbar-expand-lg navbar-dark primary-color">
  
    <!-- Navbar brand -->
    <a class="navbar-brand" href="#">Salud Mental</a>
  
    <!-- Collapse button -->
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#basicExampleNav" aria-controls="basicExampleNav"
        aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
  
    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="basicExampleNav">
        <ul class="navbar-nav ml-auto nav-flex-icons">
          <li class="nav-item avatar">
          <a class="nav-link p-0" href="index.html">
              <img src="img/avatar-placeholder.jpg" class="rounded-circle z-depth-0"
                alt="Avatar de usuario" height="35">
            </a>
          </li>
        </ul>
    </div>
    <!-- Collapsible content -->
  
  </nav>
  <!--/.Navbar-->
 

<!-- DATA -->
<script language="javascript">
<!--
  var api_host = document.location.protocol + "//" + document.location.host;
  var data;
  var questions = "";
  var current_question = 0;
  var total_questions = 0;
  var mental_test_list = "";
  var current_user = "";
  var id = get_url_vars()["id"];

  // Read a page's GET URL variables and return them as an associative array.
  // https://stackoverflow.com/questions/4656843/get-querystring-from-url-using-jquery
    function get_url_vars() {
      var vars = [], hash;
      var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
      for(var i = 0; i < hashes.length; i++) {
        hash = hashes[i].split('=');
        vars.push(hash[0]);
        vars[hash[0]] = hash[1];
      }
      return vars;
    }

    function add_question(m, index) {
      var middle_range = Math.round(m.field_type.final_range / 2);
      questions += '<li id="question-' + index + '" class="d-none">' +
        '<input type="radio" id="f-option" name="selector">' +
        '<h4>' + index + '.&nbsp;' + m.name + '</h4>' +
        '<strong>' + m.field_type.initial_label + '</strong>&nbsp;' +
        '<input type="range" min="' + m.field_type.initial_range +
        '" max="' + m.field_type.final_range + '" value="' + middle_range +
        '" class="slider" id="question_range-' + index + '" name="' +
        //m.id + '" onMouseDown="set_question(' + m.id + ')">' +
        m.id + '" onMouseDown="set_question(this)">' +
        '&nbsp;<strong>' + m.field_type.final_label + '</strong>' +
        '<p>Valor: <span id="output-' + m.id  + '"></span></p>' +
        '</li>';
    }



    function add_mental_test(m, index) {
      console.log("MENTAL TEST: " + m.name);
      //mental_test_list += '<li><a href="
    }

    function set_question(slider) {
      output = document.getElementById("output-" + slider.name);
      output.innerHTML = slider.value;

      slider.oninput = function() {
        output.innerHTML = this.value;
      }
    }


    // Load questions
    $( document ).ready(function() {
      // Get questions
      console.log("Loading questions...");
      $.getJSON(api_host + "/mental_test/" + id, function( data ) {
        for (i = 0; i < data.mental_test_fields.length; i++) {
          add_question(data.mental_test_fields[i], i + 1);
        }

        current_user = data.current_user;

        $("#test-name").html(data.name);
        $("#test-questions").html(questions);
        //$("#question-1").hide().removeClass('d-none');
        $("#question-1").removeClass('d-none');
        current_question = 1;
        total_questions = data.mental_test_fields.length;
        console.log("questions succesfully loaded" );

      })
      .fail(function(jqxhr, text, error) {
        //TODO: catch errors and show proper message
        console.log("ERROR: " + jqxhr.responseText);
        alert("ERROR: " + jqxhr.responseText);

      });
 
      // Get mental tests
      console.log("Loading Mental Test list...");
      $.getJSON(api_host + "/mental_test/", function( data ) {
        for (i = 0; i < data.length; i++) {
          add_mental_test(data[i], i + 1);
        }
      });
    });


    function show_previous_question() {
      if (current_question > 1) {
        $("#question-" + current_question).addClass('d-none');
        current_question = current_question - 1;
        $("#question-" + current_question).removeClass('d-none');
      }
    }


    function show_next_question() {
      if (current_question < total_questions ) {
        $("#question-" + current_question).addClass('d-none');
        current_question = current_question + 1;
        $("#question-" + current_question).removeClass('d-none');
      }
    }


    function serialize_question() {
      post_data = "[";
      for(i = 1; i <= total_questions; i++) {
        qs = document.getElementById("question_range-" + i);
        post_data += '{' +
          '"user": "' + current_user + '"' +
          ', "test": "' + id + '"' +
          ', "test_field": "' + qs.name + '"' +
          ', "value": "' + qs.value + '"' +
          '},';
      }
      post_data = post_data.replace(/,$/, "");
      post_data += "]";
      return post_data;
    }


    function send_mental_test(f) {
      post_data = serialize_question();
      csrf = Cookies.get("csrftoken");
      $.ajaxSetup({
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-CSRFToken': csrf
        }
      });
      $.post( "/mental_test_results/", post_data)
      .fail(function(jqxhr, text, error) {
        console.log("Mental test failed: " + jqxhr.responseText);
        alert("Mental test failed: " + jqxhr.responseText);
      })
      .done(function(data) {
        alert(data.success);
      });
    }
   // -->
  </script>
   <!-- /DATA -->

  </header>
  <!--Main Navigation-->

  <div class="container-fluid">
    <div class="row">
      <div class="col-md-2 mt-5"> 
        <p>Menú:</p>
        <a href="/static/mental_test_list.html">Cuestionarios</a>
        <ul id="mental_test_list"></ul>
      </div>
      <div class="col-md-10">
     <!--Main layout-->
     <main class="mt-5">
       <div id="test-container">  
         <h1 id="test-name">Test</h1>
         <form id="mental_test" name="mental_test">
         <input type="hidden" id="current_user" name="current_user" value="" />
         <ul id="test-questions" class="col-sm">
           <li>
            <div class="loading">Cargando preguntas...</div>
           </li>
       </ul>
    </div>

  <button type="button" id="button_previous" class="btn btn-indigo" data-toggle="modal" onClick="show_previous_question()">
    Anterior
  </button>

  <button type="button" id="button_next" class="btn btn-indigo" data-toggle="modal" onclick="show_next_question()">
    Siguiente
  </button>

  <div>
    <button type="button" class="btn btn-indigo" data-toggle="modal" onclick="send_mental_test(this.form)">
      Enviar
    </button>
  </div>
</form>

</main>

<!--Main layout-->


      </div>
    </div>
  </div>

<!-- Footer -->
<footer class="page-footer font-small blue pt-4 mt-4">

  <!-- Footer Links -->
  <div class="container-fluid text-center text-md-left">

    <!-- Grid row -->
    <div class="row">

      <!-- Grid column -->
      <div class="col-md-6 mt-md-0 mt-3">

        <!-- Content -->
        <h5 class="text-uppercase">Contenido del Footer</h5>
        <p>Cualquier cosa que se necesite aqui.</p>

      </div>
      <!-- Grid column -->

      <hr class="clearfix w-100 d-md-none pb-3">

      <!-- Grid column -->
      <div class="col-md-3 mb-md-0 mb-3">
        Links etc 1
        </div>
        <!-- Grid column -->

        <!-- Grid column -->
        <div class="col-md-3 mb-md-0 mb-3">
Links etc 2
        </div>
        <!-- Grid column -->

    </div>
    <!-- Grid row -->

  </div>
  <!-- Footer Links -->

  <!-- Copyright -->
  <div class="footer-copyright text-center py-3">© 2020 Copyright: SaludMental
  </div>
  <!-- Copyright -->

</footer>
<!-- Footer -->

  <!-- End your project here-->

  <!-- jQuery -->
  <script type="text/javascript" src="js/jquery.min.js"></script>
  <!-- Bootstrap tooltips -->
  <script type="text/javascript" src="js/popper.min.js"></script>
  <!-- Bootstrap core JavaScript -->
  <script type="text/javascript" src="js/bootstrap.min.js"></script>
  <!-- MDB core JavaScript -->
  <script type="text/javascript" src="js/mdb.min.js"></script>
  <!-- Your custom scripts (optional) -->
  <script type="text/javascript"></script>

</body>
</html>
