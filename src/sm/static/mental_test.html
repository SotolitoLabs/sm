<html>
  <head>
  <title>Adapp :: Tamices</title>
  
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <!-- Material Design Bootstrap -->
  <link rel="stylesheet" href="css/mdb.min.css">
  <!-- Your custom styles (optional) -->
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/adapp.css">
  
  
  
  <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800;900&display=swap" rel="stylesheet"> 
  
  <script src="/static/js/jquery.min.js"></script>
  <script src="/static/js/popper.min.js"></script>
<!--  <script src="/static/rest_framework/js/ajax-form.js"></script> -->
  <script src="/static/rest_framework/js/csrf.js"></script>
  <script src="/static/js/bootstrap.min.js"></script>
  <!-- <script src="/static/rest_framework/js/prettify-min.js"></script> -->
  <!-- <script src="/static/rest_framework/js/default.js"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>

  <!-- Adapp Stuff -->
<!--  <script src="/static/js/adapp/default.js"></script>
<script src="/static/js/adapp/auth.js"></script> -->
  <!-- /Adapp Stuff -->
  
  
  <style>

  </style>
  
  <!-- DATA -->
  <script language="javascript">
  <!--
    var api_host = document.location.protocol + "//" + document.location.host + "/api";
    var data;
    var questions = "";
    var indicators = "";
    var progress_bar_content = "";
    var current_question = 0;
    var total_questions = 0;
    var mental_test_list = "";
    var current_user = "";
    var mental_test_id = get_url_vars()["id"];
  
    function set_bubbles() { 
      const allRanges = document.querySelectorAll(".sm-range-wrap");
      allRanges.forEach(wrap => {
        const range = wrap.querySelector(".sm-range");
        const bubble = wrap.querySelector(".sm-bubble");
  
        range.addEventListener("input", () => {
          setBubble(range, bubble);
        });
        setBubble(range, bubble);
      });
    }
  
  
    function setBubble(range, bubble) {
      const val = range.value;
      const min = range.min ? range.min : 0;
      const max = range.max ? range.max : 100;
      const newVal = Number(((val - min) * 100) / (max - min));
      bubble.innerHTML = val;
  
      // Sorta magic numbers based on size of the native UI thumb
      bubble.style.left = `calc(${newVal}% + (${8 - newVal * 0.10}px))`;
    }
  
  
    // Read a page's GET URL variables and return them as an associative array.
    // https://stackoverflow.com/questions/4656843/get-querystring-from-url-using-jquery
    function get_url_vars() {
      var vars = [], hash;
      var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
      for(var i = 0; i < hashes.length; i++) {
        hash = hashes[i].split('=');
        vars.push(hash[0]);
        vars[hash[0]] = hash[1];
      }
      return vars;
    }
  
    function add_question(tf, tf_value, index) {
      if( tf_value <= 0 ) {
        tf_value = Math.round(tf.field_type.final_range / 2);
      }
      questions += '<div class="carousel-item sm-range-wrap" id="question-' + index + '">' +
        '<h4 style="padding-bottom: 6%">' + index + '.&nbsp;' + tf.name + '</h4>' +
        '<div class="row">' +
        '<div class="sm-bubble"><output id="output-' + tf.id  + '">' +
        tf_value + '</output></div>' +
        '<div class="col-sm-3">' + tf.field_type.initial_label + '</div>' +
        '<div class="col-sm-6"><input type="range" min="' + tf.field_type.initial_range +
        '" max="' + tf.field_type.final_range + '" value="' + tf_value +
        '" class="sm-slider sm-range" id="question_range-' + index + '" name="' +
        tf.id + '" onMouseDown="set_question(this)"> </div>' +
        '<div class="col-sm-3">' + tf.field_type.final_label + '</div>' +
        '</div>' +
        '</div>';

        indicators += '<li data-target="#carouselExampleIndicators"'+
          'data-slide-to="' + (index-1) + '" class="sm-carousel-indicator active"></li>'
    }
  
  
  
    function add_mental_test(m, index) {
      console.log("LOADING MENTAL TEST: " + m.name);
      var active_class = "";
      if (m.id == mental_test_id)
        active_class = "is-active";
      progress_bar_content += '<li class="' + active_class + '" data-step="' + index + '">' +
      '<a href=/static/mental_test.html?id=' + m.id + '>' +
      m.name + '</a>' +
      '</li>'
    }
  
  
    function set_question(slider) {
      output = document.getElementById("output-" + slider.name);
      output.innerHTML = slider.value;
      slider.oninput = function() {
        output.innerHTML = this.value;
      }
    }
  
  
    // Load questions
    $( document ).ready(function() {
      // Get questions
      console.log("Loading questions...");
      $.getJSON(api_host + "/mental_test_results/" + mental_test_id, function( data ) {
        if(data[0].test_field === undefined) {
          for (i = 0; i < data.length; i++) {
            add_question(data[i], 0, i + 1);
          }
        }
        else {
          for (i = 0; i < data.length; i++) {
            add_question(data[i].test_field, data[i].value, i + 1);
          }
        }
        current_user = data[0].current_user;
  
        //Add Questions to DOM
        $("#test-name").html(data[0].test.name);
        $("#test-questions").html(questions);
        $("#question-1").addClass('active');
        $("#carousel-indicators").html(indicators);
        current_question = 1;
        total_questions = data.length;
        console.log("questions succesfully loaded" );
        /*console.log("Setting bubbles");
        set_bubbles();*/
      })
      .fail(function(jqxhr, text, error) {
        //TODO: catch errors and show proper message
        console.log("ERROR: " + jqxhr.responseText);
        //alert("ERROR: " + jqxhr.responseText);
      });
   
      // Get mental tests
      console.log("Loading Mental Test list...");
      $.getJSON(api_host + "/mental_test/", function( data ) {
        for (i = 0; i < data.length; i++) {
          add_mental_test(data[i], i + 1);
        }
        $("#progress-bar").html(progress_bar_content);
      });
    });
  
  
    function show_previous_question() {
      if (current_question > 1) {
        $("#question-" + current_question).removeClass('active');
        current_question = current_question - 1;
        $("#question-" + current_question).addClass('active');
      }
    }
  
  
    function show_next_question() {
      if (current_question < total_questions ) {
        $("#question-" + current_question).removeClass('active');
        current_question = current_question + 1;
        $("#question-" + current_question).addClass('active');
      }
    }
  
  
    function serialize_question() {
      post_data = "[";
      for(i = 1; i <= total_questions; i++) {
        qs = document.getElementById("question_range-" + i);
        post_data += '{' +
          '"user": "' + current_user + '"' +
          ', "test": "' + mental_test_id + '"' +
          ', "test_field": "' + qs.name + '"' +
          ', "value": "' + qs.value + '"' +
          '},';
      }
      post_data = post_data.replace(/,$/, "");
      post_data += "]";
      return post_data;
    }
  
  
    function send_mental_test(f) {
      post_data = serialize_question();
      csrf = Cookies.get("csrftoken");
      $.ajaxSetup({
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-CSRFToken': csrf
        }
      });
      $.post(api_host + "/mental_test_results/", post_data)
      .fail(function(jqxhr, text, error) {
        console.log("Mental test failed: " + jqxhr.responseText);
        alert("Mental test failed: " + jqxhr.responseText);
      })
      .done(function(data) {
        alert(data.success);
      });
    }
     // -->
    </script>
    <!-- /DATA -->
  
  
  
  </head>
  <body>
    <div class="sm-header">
        <h1 class="sm-header-title"><img class="sm-header-img" src="/static/img/adapp_logo1.png">&nbsp;adapp</h1><a style="color: black" href="/api/api-auth/logout/?next=/mental_test.html?id=1">Salir</a>
    </div>  


    <div class="sm-slidecontainer">
  
      <!-- START PROGRESS BAR -->
      <ol id="progress-bar" class="sm-progress">
        <li class="is-active" data-step="1">
          Test 1
        </li>
        <li data-step="2">
          Test 2
        </li>
        <li data-step="3">
          Test 3
        </li>    
        <li data-step="4" class="progress__last">
          Test 4
        </li>
      </ol>
      <!-- /FINISH PROGRESS BAR -->
    
  
      <!-- START QUESTIONS -->
      <div class="mt-5 container-fluid">
          <h1 class="sm-test-name-title" id="test-name"><a style="color: black" href="/api/api-auth/login/?next=/mental_test.html?id=1">Login</a></h1>
        <input type="hidden" id="current_user" name="current_user" value="" />

        <form id="mental_test" name="mental_test">
          <div id="test-container" class="row carousel slide" data-interval="false" data-ride="carousel">

          <ol id="carousel-indicators" class="carousel-indicators" style="margin-bottom: -2%">
            <li data-target="#carouselExampleIndicators" data-slide-to="0" class="sm-carousel-indicator active"></li>
            <li data-target="#carouselExampleIndicators" data-slide-to="1" class="sm-carousel-indicator"></li>
            <li data-target="#carouselExampleIndicators" data-slide-to="2" class="sm-carousel-indicator"></li>
          </ol>



            <div id="test-questions" class="carousel-inner">
                <div class="loading"><img src="/static/img/beta_adapp_buffering-80.gif" /></div>
            </div>


            <a class="carousel-control-prev" href="#test-container" role="button" data-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="sr-only">Previous</span>
            </a>
            <a class="carousel-control-next" href="#test-container" role="button" data-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="sr-only">Next</span>
            </a>


          </div>
          <div class="row">
            <!-- CONTROLS --> 
            <div class="col">
 <!--             <button type="button" id="button_previous" class="sm-button" data-toggle="modal" onClick="show_previous_question()">
                Anterior
              </button>
  
              <button type="button" id="button_next" class="sm-button" data-toggle="modal" onclick="show_next_question()">
                Siguiente
              </button> -->
              <div>
                <button type="button" class="sm-button" data-toggle="modal" onclick="send_mental_test(this.form)">
                  Enviar
                </button>
              </div>
            </div>
            <!-- /CONTROLS -->
          </div>

        </form>

      </div>
      <!-- /END QUESTIONS -->
  
    </div>
  </body>
</html>
